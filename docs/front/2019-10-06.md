---
title: 'reactè§£æ: renderçš„ä¸­çš„update(å››)'
description: HerryLo, å¾®ä¿¡å…¬ä¼—å·ï¼š Yopai
date: 2019-10-06 00:00
tags: 
  - reactï¼Œè§£æ
---

> æ„Ÿè°¢ [yck: å‰–æ React æºç è§£æ](https://github.com/KieSun/Dream/issues/19)ï¼Œæœ¬ç¯‡æ–‡ç« æ˜¯åœ¨è¯»å®Œä»–çš„æ–‡ç« çš„åŸºç¡€ä¸Šï¼Œå°†ä»–çš„æ–‡ç« è¿›è¡Œæ‹†è§£å’ŒåŠ å·¥ï¼ŒåŠ å…¥æˆ‘è‡ªå·±çš„ä¸€ä¸‹ç†è§£å’Œä¾‹å­ï¼Œä¾¿äºå¤§å®¶ç†è§£ã€‚è§‰å¾—[yck](https://github.com/KieSun)å†™çš„çœŸçš„å¾ˆæ£’ ã€‚**React ç‰ˆæœ¬ä¸º 16.8.6**ï¼Œå…³äºæºç çš„é˜…è¯»ï¼Œå¯ä»¥ç§»æ­¥åˆ°[yck reactæºç è§£æ](https://github.com/KieSun/react-interpretation)

> æœ¬æ–‡æ°¸ä¹…æœ‰æ•ˆé“¾æ¥: [reactè§£æ: renderçš„ä¸­çš„update(å››)](https://github.com/AttemptWeb/Record/issues/14)

[ä¸Šä¸€ç« èŠ‚](./2019-08-10)è¯´åˆ°ï¼Œ**ä¸å­˜åœ¨rootæ•°æ®èŠ‚ç‚¹**ï¼Œå³é€šè¿‡[createFiberRoot å‡½æ•°åˆ›å»ºFiberRoot](./2019-08-10.html#åˆ›å»ºfiberrootæ ¸å¿ƒå‡½æ•°)ï¼Œ```FiberRoot```å¯¹è±¡æ˜¯æ•´ä¸ªReactåº”ç”¨çš„èµ·ç‚¹ï¼ŒåŒæ—¶ä¹Ÿè®°å½•äº†æ•´ä¸ªReactåº”ç”¨æ›´æ–°è¿‡ç¨‹ä¸­çš„å„ç§ä¿¡æ¯ã€‚

ä¸‹é¢å°†è¦èŠåˆ°çš„å°±æ˜¯ï¼Œå½“rootå‘—åˆ›å»ºåï¼Œè¿˜ä¼šå‘ç”Ÿä»€ä¹ˆğŸ‘‡ğŸ‘‡

### legacyRenderSubtreeIntoContainer å‡½æ•°

ä¸‹é¢è¡”æ¥ä¸Šä¸€éƒ¨åˆ†å†…å®¹ï¼Œä¸æ‡‚å¾—å¯ä»¥æŸ¥çœ‹[ä¸Šä¸€ç« èŠ‚](./2019-08-10)ã€‚

> [yck: ReactDOM æºç  554è¡Œ legacyRenderSubtreeIntoContainer](https://github.com/KieSun/react-interpretation/blob/master/packages/react-dom/src/client/ReactDOM.js#L554)
```javascript
function legacyRenderSubtreeIntoContainer(
  parentComponent: ?React$Component<any, any>,
  children: ReactNodeList,
  container: DOMContainer,
  forceHydrate: boolean,
  callback: ?Function,
) {
    // åˆå§‹åŒ–æ—¶ï¼Œcontainer è‚¯å®šæ²¡æœ‰ _reactRootContainerå±æ€§
    let root: Root = (container._reactRootContainer: any);
    if (!root) {
        // çœç•¥åˆ›å»ºrootéƒ¨åˆ†
        
        unbatchedUpdates(() => {
            if (parentComponent != null) {
                root.legacy_renderSubtreeIntoContainer(
                    parentComponent,
                    children,
                    callback,
                );
            } else {
                root.render(children, callback);
            }
        });
    }
}
```
åœ¨rootåˆšåˆšè¢«åˆ›å»ºæ—¶ï¼Œ```parentComponent```ä¸€èˆ¬éƒ½ä¸ºnullï¼›

```unbatchedUpdates```å‡½æ•°åœ¨è¿™é‡Œä½œç”¨æ˜¯ï¼šå‘ŠçŸ¥Reactå†…éƒ¨ä¸è¿›è¡Œæ‰¹é‡æ›´æ–°ï¼Œå³ä¸ç”¨å°†å¤šä¸ªsetStateåˆå¹¶ä¸ºä¸€ä¸ªï¼›
ï¼ˆ**setStateåœ¨åé¢çš„ç« èŠ‚æˆ‘ä»¬å°†ä¼šè¯´åˆ°**ï¼‰

é‚£ä¹ˆè¿™é‡Œ**å®é™…è°ƒç”¨çš„å°±æ˜¯root.renderå‡½æ•°ï¼Œrootæ˜¯ReactRootå®ä¾‹å¯¹è±¡ï¼Œå³è°ƒç”¨ ```root.renderå‡½æ•° == ReactRoot.prototype.renderå‡½æ•°```**ã€‚

### ReactRoot.prototype.render å‡½æ•°

> [yck: ReactRoot æºç  377è¡Œ ReactRoot.prototype.render](https://github.com/KieSun/react-interpretation/blob/master/packages/react-dom/src/client/ReactDOM.js#L377)

```javascript
ReactRoot.prototype.render = function(
  children: ReactNodeList,
  callback: ?() => mixed,
): Work {
  // è¿™é‡ŒæŒ‡ FiberRoot
  const root = this._internalRoot;
  const work = new ReactWork();
  callback = callback === undefined ? null : callback;

  // å¦‚æœæœ‰ callbackï¼Œå°± push è¿› work ä¸­çš„æ•°ç»„
  if (callback !== null) {
    work.then(callback);
  }
  // work._onCommit å°±æ˜¯ç”¨äºæ‰§è¡Œæ‰€æœ‰å›è°ƒå‡½æ•°çš„
  updateContainer(children, root, null, work._onCommit);
  return work;
};
```
å‡½æ•°ä¸­çš„å‚æ•°```children```å³æ˜¯ReactElementèŠ‚ç‚¹å¯¹è±¡ï¼Œ```callback```ä¸ºå›è°ƒå‡½æ•°ã€‚**```ReactWork```å®ä¾‹å¯¹è±¡çš„ä¸»è¦ä½œç”¨å°±æ˜¯ç»´æŠ¤ä¸€ä¸ªå›è°ƒæ•°ç»„**ï¼Œå¯æŸ¥çœ‹[yck: ReactWork æºç  327è¡Œ](https://github.com/KieSun/react-interpretation/blob/master/packages/react-dom/src/client/ReactDOM.js#L327)ï¼Œå¦‚æœä¼ å…¥å‚æ•°ä¸­å­˜åœ¨callbackï¼Œå°±å°†å…¶æŒ‚è½½```ReactWork```å®ä¾‹å¯¹è±¡ä¸­;

ä¸‹é¢æ¥çœ‹çœ‹updateContainerå‡½æ•°ä¼šåšä»€ä¹ˆã€‚

### updateContainer å‡½æ•°

> [yck: ReactFiberReconciler æºç  284è¡Œ updateContainer](https://github.com/KieSun/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js#L284)

```javascript
export function updateContainer(
  element: ReactNodeList,
  container: OpaqueRoot,
  parentComponent: ?React$Component<any, any>,
  callback: ?Function,
): ExpirationTime {
  const current = container.current;
  // è®¡ç®—æ—¶é—´
  const currentTime = requestCurrentTime();
  // expirationTime ä»£è¡¨ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
  // sync çš„æ•°å­—æ˜¯æœ€å¤§çš„ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§ä¹Ÿæ˜¯æœ€é«˜çš„
  const expirationTime = computeExpirationForFiber(currentTime, current);
  return updateContainerAtExpirationTime(
    element,
    container,
    parentComponent,
    expirationTime,
    callback,
  );
}
```
```container.current```å³æ˜¯ä»FiberRootä¸­å–å‡º```RootFiber```å¯¹è±¡ï¼Œ**```currentTime```å°±æ˜¯å½“å‰è·ç¦»Reactåº”ç”¨åˆå§‹åŒ–çš„æ—¶é—´**ã€‚ **```expirationTime```å­—é¢æ„æ€å°±æ˜¯è¿‡æœŸæ—¶é—´ï¼Œåé¢æˆ‘ä¼šä¸“é—¨èŠ±ä¸€ç« çš„æ—¶é—´æ¥ä»‹ç»è¿™ä¸¤ä¸ªæ—¶é—´ï¼Œè¿™ä¸¤ä¸ªæ—¶é—´ä¹Ÿæ˜¯Reactåº”ç”¨ä»»åŠ¡è°ƒåº¦çš„é‡ç‚¹ã€‚

### scheduleRootUpdateå‡½æ•°

updateContainerAtExpirationTimeå‡½æ•°å®é™…è°ƒç”¨çš„å°±æ˜¯```scheduleRootUpdate```å‡½æ•°ï¼Œä¸‹é¢æ¥è¯´ä¸€ä¸‹```scheduleRootUpdate```å‡½æ•°çš„ä½œç”¨ã€‚

> [yck: ReactFiberReconciler æºç  114è¡Œ scheduleRootUpdate](https://github.com/KieSun/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js#L114)

```javascript
function scheduleRootUpdate(
  current: Fiber,
  element: ReactNodeList,
  expirationTime: ExpirationTime,
  callback: ?Function,
) {
  // åˆ›å»ºä¸€ä¸ª updateï¼Œå°±æ˜¯å†…éƒ¨æœ‰å‡ ä¸ªå±æ€§çš„å¯¹è±¡
  const update = createUpdate(expirationTime);
  update.payload = {element};

  // renderä¸­çš„å›è°ƒå‡½æ•° 
  callback = callback === undefined ? null : callback;
  if (callback !== null) {
    update.callback = callback;
  }

  flushPassiveEffects();
  // æŠŠ update å…¥é˜Ÿï¼Œå†…éƒ¨å°±æ˜¯ä¸€äº›åˆ›å»ºæˆ–è€…è·å– queueï¼ˆé“¾è¡¨ç»“æ„ï¼‰ï¼Œç„¶åç»™é“¾è¡¨æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œ
  enqueueUpdate(current, update);
  scheduleWork(current, expirationTime);

  return expirationTime;
}
```
ä¸‹é¢å°±æ˜¯updateå¯¹è±¡å…¶ä¸­çš„å±æ€§ï¼š

```javascript
// updateå¯¹è±¡å±æ€§
export type Update<State> = {
  // æ›´æ–°çš„è¿‡æœŸæ—¶é—´
  expirationTime: ExpirationTime,

  // export const UpdateState = 0;
  // export const ReplaceState = 1;
  // export const ForceUpdate = 2;
  // export const CaptureUpdate = 3;
  // æŒ‡å®šæ›´æ–°çš„ç±»å‹ï¼Œå€¼ä¸ºä»¥ä¸Šå‡ ç§
  tag: 0 | 1 | 2 | 3,
  // æ›´æ–°å†…å®¹ï¼Œæ¯”å¦‚`setState`æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°
  payload: any,
  // å¯¹åº”çš„å›è°ƒï¼Œ`setState`ï¼Œ`render`éƒ½æœ‰
  callback: (() => mixed) | null,

  // æŒ‡å‘ä¸‹ä¸€ä¸ªæ›´æ–°
  next: Update<State> | null,
  // æŒ‡å‘ä¸‹ä¸€ä¸ª`side effect`
  nextEffect: Update<State> | null,
};
```
**udateå¯¹è±¡ä¼šè¢«æ’å…¥åˆ°Reactåº”ç”¨ç»´æŠ¤çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä¸ç®¡ä½ æ˜¯setStateè¿˜æ˜¯ReactDOM.renderé€ æˆçš„ Reactåº”ç”¨ æ›´æ–°**éƒ½æ˜¯å¦‚æ­¤ã€‚è¿™ä¸ªå‡½æ•°æ ¸å¿ƒä½œç”¨å°±æ˜¯åˆ›å»ºæˆ–è€…è·å–ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åæŠŠ update å¯¹è±¡æ’å…¥é˜Ÿåˆ—è¿›è¡Œæ›´æ–°ã€‚```scheduleWork```å‡½æ•°å°±æ˜¯ä»»åŠ¡è°ƒåº¦çš„ä¸œè¥¿äº†ã€‚

æ›´å¤šå†…å®¹ï¼š

[reactè§£æ: React.createElement(ä¸€)](https://github.com/AttemptWeb/Record/issues/7)

[reactè§£æ: React.Children(äºŒ)](https://github.com/AttemptWeb/Record/issues/8)

[reactè§£æ: renderçš„FiberRoot(ä¸‰)](https://github.com/AttemptWeb/Record/issues/9)

å‚è€ƒï¼š

[yck: å‰–å‰–æ React æºç ](https://github.com/KieSun/Dream/issues/18)

[Jokcy çš„ ã€ŠReact æºç è§£æã€‹: react.jokcy.me/](https://react.jokcy.me/book/api/react-element.html)

ps: é¡ºä¾¿æ¨ä¸€ä¸‹è‡ªå·±çš„ä¸ªäººå…¬ä¼—å·ï¼šYopaiï¼Œæœ‰å…´è¶£çš„å¯ä»¥å…³æ³¨ï¼Œæ¯å‘¨ä¸å®šæœŸæ›´æ–°ï¼Œåˆ†äº«å¯ä»¥å¢åŠ ä¸–ç•Œçš„å¿«ä¹

![](/webChat1.png)

<!-- #### requestCurrentTimeå‡½æ•°

```currentTime```æ˜¯ç”±requestCurrentTimeå‡½æ•°è¿”å›ï¼Œä½†æ˜¯å®ƒçš„æ ¸å¿ƒæ˜¯```msToExpirationTime```å‡½æ•°.

> [yck: ReactFiberExpirationTime æºç  31è¡Œ msToExpirationTime](hhttps://github.com/KieSun/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberExpirationTime.js#L31)
```javascript
export function msToExpirationTime(ms: number): ExpirationTime {
  // ms -> è¡¨ç¤ºä¸ºè·ç¦» React åº”ç”¨åˆå§‹åŒ–å·²ç»è¿‡å»çš„æ¯«ç§’æ—¶é—´
  // UNIT_SIZE = 10
  // MAGIC_NUMBER_OFFSE = 1073741823 - 1
  // 1073741823 - ((ms / 10) | 0)  å–æ•´
  return MAGIC_NUMBER_OFFSET - ((ms / UNIT_SIZE) | 0);
}
``` -->
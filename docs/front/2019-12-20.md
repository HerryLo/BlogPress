---
title: 'ğŸ”¥react-reduxåŸç†è§£æ'
description: HerryLo, å¾®ä¿¡å…¬ä¼—å·ï¼š Yopai
data: 2019-12-20 11:40
tags: react-reduxï¼ŒåŸç†è§£æ
---

# react-reduxåŸç†è§£æ

åœ¨ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­å·²è®²è¿‡[redux åŸç†è§£æ](https://didiheng.com/front/2019-10-26.html)ï¼Œæˆ‘å°†```redux```è¿”å›çš„storeå¯¹è±¡æŒ‚è½½åœ¨windowä¸­ï¼Œä¸æ˜¯å¤ªæ‡‚çš„åŒå­¦å¯ä»¥çœ‹çœ‹ä¹‹å‰çš„[redux åŸç†è§£æ](https://didiheng.com/front/2019-10-26.html)ã€‚

```javascript
const reducer = combineReducers({
    home: homeNumber,
    number: addNumber
})
const store = createStore(reducer)
window.$reduxStore = store

// ä½¿ç”¨
window.$reduxStore.dispatch(action);
let { state } = window.$reduxStore.getState()
```
ä½†åœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œä¸€èˆ¬å´æ˜¯å°†```redux+c```é…åˆä½¿ç”¨ï¼Œä¸‹é¢å°±ä¸€èµ·æ¥è§£æ```react-redux```å¸¸ä½¿ç”¨çš„æ–¹æ³•ã€‚<span style="color: red;font-weight: 900;">ã€ä¸‹é¢æ˜¯ä»¥æœ€æ–°ç‰ˆæœ¬react-redux@7.1.3åº“è§£æã€‘</span>ï¼Œã€ä¸‹é¢çš„æºç å°½é‡ç®€ç•¥ã€‘

## Providerå‡½æ•°

```react-redux```æä¾›äº†```<Provider />```ç”¨æ¥æŒ‚è½½reduxè¿”å›çš„storeå¯¹è±¡ï¼Œåªéœ€è¦æ³¨å…¥ä¸€æ¬¡ã€‚

```javascript
ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  rootElement
)
```
ä¸‹é¢çœ‹çœ‹```<Provider store={store} />```åšäº†ä»€ä¹ˆï¼š

```javascript
function Provider({ store, context, children }) {
  // ä¾èµ–é¡¹storeå˜åŒ–è§¦å‘ï¼Œè¿”å›storeå’Œsubscription
  const contextValue = useMemo(() => {
    //...
    return {
      store,
      subscription
    }
  }, [store])
  //...
  
  // ReactReduxContext = React.createContext(null)
  const Context = context || ReactReduxContext

  return <Context.Provider value={contextValue}>{children}</Context.Provider>
}
// æºç åœ°å€ï¼šhttps://github.com/reduxjs/react-redux/blob/master/src/components/Provider.js#L6
```
Provideræ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œstoreå‚æ•°æ¥æ”¶storeå¯¹è±¡ï¼Œcontextå‚æ•°æ¥æ”¶ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œchildrenå‚æ•°æ¥æ”¶ReactElementå…ƒç´ ï¼›
åœ¨åŸåº”ç”¨ç»„ä»¶ä¸ŠåŒ…è£¹ä¸€å±‚ï¼Œä½¿åŸæ¥æ•´ä¸ªåº”ç”¨æˆä¸ºProviderçš„å­ç»„ä»¶ï¼Œ[Context.Provider API](https://zh-hans.reactjs.org/docs/context.html#contextprovider)ï¼šåªæœ‰å½“ Provider çš„ value å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå†…éƒ¨çš„æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚

```contextValue```ä¸ŠæŒ‚è½½äº†storeå’Œè®¢é˜…æ›´æ–°subscriptionå¯¹è±¡ï¼Œstoreåœ¨è¿™é‡Œä¸åšè§£é‡Šï¼Œå°±æ˜¯reduxè¿”å›çš„storeã€‚åœ¨ä¸‹é¢å°†ä¼šç»§ç»­è¯´åˆ°subscriptionè®¢é˜…å‡½æ•°ã€‚

## connectå‡½æ•°

```connect```çš„å¸¸è§ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
return connect(mapStateToProps, mapDispatchToProps)(Component)
```

```connect```å‡½æ•°å°±æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯å°†```state```å’Œ```dispatch```ç­‰å±æ€§æŒ‚è½½Componentçš„propsä¸Šã€‚

```javascript
import hoistStatics from 'hoist-non-react-statics'
import { ReactReduxContext } from './Context';

// æ ¸å¿ƒå‡½æ•° returnç»„ä»¶
function ConnectFunction (props) {
  // åˆ¤æ–­props æ˜¯å¦å­˜åœ¨store & getState & dispatch
  var didStoreComeFromProps = Boolean(props.store) && Boolean(props.store.getState) && Boolean(props.store.dispatch);
  // è·å–åˆ°Providerç»„ä»¶æŒ‚è½½çš„contextValue
  var ContextToUse = useMemo(function () {
    return props.context || ReactReduxContext
  })
  var contextValue = useContext(ContextToUse)
  //  ...
  // storeå¯¹è±¡
  var store = didStoreComeFromProps ? props.store : contextValue.store;

  // ä¾èµ–è¿”å› contextValue
  var overriddenContextValue = useMemo(function () {
    if (didStoreComeFromProps) {
      return contextValue;
    }
    // copyä¸€ä¸ªæ–°çš„contextValue
    return _extends({}, contextValue, {
      subscription: subscription
    });
  }, [didStoreComeFromProps, contextValue, subscription]);

  //  ...
  // è¿”å›æ¸²æŸ“ReactElement
  var renderedChild = useMemo(function () {
    // æ˜¯å¦å­˜åœ¨mapStateToPropså‡½æ•°
    if (shouldHandleStateChanges) {
      return React.createElement(ContextToUse.Provider, {
        value: overriddenContextValue
      }, renderedWrappedComponent);
    }
    // renderedWrappedComponent æ¸²æŸ“å®¹å™¨ç»„ä»¶
    return renderedWrappedComponent;
  }, [ContextToUse, renderedWrappedComponent, overriddenContextValue]);
  return renderedChild;
}
//  ...
// ä¸Object.assignç±»ä¼¼æ“ä½œ
return hoistStatics(ConnectFunction, Component)
```

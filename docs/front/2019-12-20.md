---
title: 'ğŸ”¥react-reduxåŸç†è§£æ'
description: HerryLo, å¾®ä¿¡å…¬ä¼—å·ï¼š Yopai
date: 2019-12-20 11:40
tags: 
  - react-reduxï¼ŒåŸç†è§£æ
---

# react-reduxåŸç†è§£æ

[ä½œè€…ï¼šHerryLo](https://github.com/HerryLo)
[åšå®¢åŸæ–‡é“¾æ¥](https://github.com/AttemptWeb/Record/issues/20)

åœ¨ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­å·²è®²è¿‡[redux åŸç†è§£æ](https://herrylo.github.io/front/2019-10-26.html)ï¼Œæˆ‘å°†```redux```è¿”å›çš„storeå¯¹è±¡æŒ‚è½½åœ¨windowä¸­ï¼Œä¸æ˜¯å¤ªæ‡‚çš„åŒå­¦å¯ä»¥çœ‹çœ‹ä¹‹å‰çš„[redux åŸç†è§£æ](https://herrylo.github.io/front/2019-10-26.html)ã€‚

```javascript
const reducer = combineReducers({
    home: homeNumber,
    number: addNumber
})
const store = createStore(reducer)
window.$reduxStore = store

// ä½¿ç”¨
window.$reduxStore.dispatch(action);
let { state } = window.$reduxStore.getState()
```
ä½†åœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œä¸€èˆ¬æ˜¯å°†```redux+react-redux+react```é…åˆä½¿ç”¨ï¼Œé‚£ä¹ˆï¼Œä¸‹é¢å°±ä¸€èµ·æ¥çœ‹çœ‹```react-redux```ä¸­çš„å¸¸è§æ–¹æ³•ï¼Œå®ƒå…·ä½“åšäº†ä»€ä¹ˆã€‚<span style="color: red;font-weight: 900;">ã€ä¸‹é¢æ˜¯ä»¥æœ€æ–°ç‰ˆæœ¬react-redux@7.1.3åº“è§£æã€‘</span>(ä¸‹é¢çš„æºç éƒ¨åˆ†çœç•¥)

## Providerå‡½æ•°

```react-redux```æä¾›äº†```<Provider />```ç»„ä»¶ç”¨æ¥æŒ‚è½½reduxè¿”å›çš„storeå¯¹è±¡ï¼ŒåŒæ—¶å°†æ•´ä¸ªåº”ç”¨ä½œä¸ºProviderçš„å­ç»„ä»¶ã€‚

```javascript
ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  rootElement
)
```
ä¸‹é¢çœ‹çœ‹```<Provider />```ç»„ä»¶åšäº†ä»€ä¹ˆï¼š

```javascript
function Provider({ store, context, children }) {
  // ä¾èµ–é¡¹storeå˜åŒ–è§¦å‘ï¼Œè¿”å›storeå’Œsubscription
  const contextValue = useMemo(() => {
    // è®¢é˜…ç›‘å¬Subscriptionå‡½æ•°ï¼Œä¸‹é¢ä¼šä¸“é—¨è¯´åˆ°
    const subscription = new Subscription(store)
    subscription.onStateChange = subscription.notifyNestedSubs
    return {
      store,
      subscription
    }
  }, [store])
  //...
  
  // ReactReduxContext = React.createContext(null)
  const Context = context || ReactReduxContext

  return <Context.Provider value={contextValue}>{children}</Context.Provider>
}
// æºç åœ°å€ï¼šhttps://github.com/reduxjs/react-redux/blob/master/src/components/Provider.js#L6
```
Provideræ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œstoreå‚æ•°æ¥æ”¶storeå¯¹è±¡ï¼Œcontextå‚æ•°æ¥æ”¶ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œchildrenå‚æ•°æ¥æ”¶ReactElementå…ƒç´ ï¼›
åœ¨åŸåº”ç”¨ç»„ä»¶ä¸ŠåŒ…è£¹ä¸€å±‚ï¼Œä½¿åŸæ¥æ•´ä¸ªåº”ç”¨æˆä¸ºProviderçš„å­ç»„ä»¶ï¼Œ[Context.Provider API](https://zh-hans.reactjs.org/docs/context.html#contextprovider)ï¼š**åªæœ‰å½“ Provider çš„ value å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå†…éƒ¨çš„æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“**ã€‚

å°†```contextValue```æŒ‚è½½åœ¨Providerä¸Šï¼ŒcontextValueåŒ…å«storeå¯¹è±¡å’Œè®¢é˜…å‘å¸ƒsubscriptionå¯¹è±¡ï¼Œä»¥å¤‡```connect```ç»„ä»¶ä½¿ç”¨è·å–ã€‚Subscriptionä¸»è¦è´Ÿè´£connectã€Providerç»„ä»¶çš„æ›´æ–°ï¼Œå±äºæ ¸å¿ƒå†…å®¹ï¼Œè¿™äº›å°†åœ¨ä¸‹é¢è®²åˆ°ã€‚

## connectå‡½æ•°

```connect```çš„å¸¸è§ä½¿ç”¨ç¤ºä¾‹ï¼š
```javascript
return connect(mapStateToProps, mapDispatchToProps)(Component)
```
**```connect```å‡½æ•°å°±æ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œå°†ä»¥ä¸Šçš„å‚æ•°ä¼ å…¥å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ç»„ä»¶**ï¼Œä¸»è¦å°±æ˜¯å°†```state```å’Œ```dispatch```ç­‰å±æ€§æŒ‚è½½Componentçš„propsä¸Šã€‚
```javascript
import hoistStatics from 'hoist-non-react-statics'
import { ReactReduxContext } from './Context';

// æ ¸å¿ƒå‡½æ•° returnç»„ä»¶
function ConnectFunction (props) {
  //  ...
  // åˆ¤æ–­props æ˜¯å¦å­˜åœ¨store & getState & dispatchï¼Œä¸€èˆ¬éƒ½ä¸ºfalse
  var didStoreComeFromProps = Boolean(props.store) && Boolean(props.store.getState) && Boolean(props.store.dispatch);
  // è·å–Providerç»„ä»¶æŒ‚è½½çš„contextValue
  var ContextToUse = useMemo(function () {
    return propsContext &&
          propsContext.Consumer &&
          isContextConsumer(<propsContext.Consumer />)
          ? propsContext
          : Context
  })
  // contextValue = { store, subscription }
  var contextValue = useContext(ContextToUse)

  //  ...
  // ä¾èµ–è¿”å› contextValue
  var overriddenContextValue = useMemo(function () {
    if (didStoreComeFromProps) {
      return contextValue
    }
    return {
      ...contextValue,
      subscription
    }
  }, [didStoreComeFromProps, contextValue, subscription]);

  //  ...
  // actualChildProps == propsï¼Œä¸ŠæŒ‚è½½äº†```state```å’Œ```dispatch```ç­‰å±æ€§
  const renderedWrappedComponent = useMemo(
    () => <WrappedComponent {...actualChildProps} ref={forwardedRef} />,
    [forwardedRef, WrappedComponent, actualChildProps]
  )
  // è¿”å›æ¸²æŸ“ReactElement
  var renderedChild = useMemo(function () {
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨mapStateToPropså‡½æ•°
    if (shouldHandleStateChanges) {
      return (
        <ContextToUse.Provider value={overriddenContextValue}>
          {renderedWrappedComponent}
        </ContextToUse.Provider>
      )
    }
    // renderedWrappedComponent æ¸²æŸ“å®¹å™¨ç»„ä»¶
    return renderedWrappedComponent
  }, [ContextToUse, renderedWrappedComponent, overriddenContextValue]);
  return renderedChild;
}
//  ...
// ä¸Object.assignç±»ä¼¼æ“ä½œ
return hoistStatics(ConnectFunction, WrappedComponent)
```
[```hoistStatics```](https://github.com/mridgway/hoist-non-react-statics)å‡½æ•°çš„ä½œç”¨å°±æ˜¯ç±»ä¼¼äºObject.assignï¼Œå¯ä»¥è¿™æ ·ç†è§£```hoistStatics(targetComponent, sourceComponent)```ï¼Œ[hoist-non-react-staticsåº“](https://github.com/mridgway/hoist-non-react-statics)ã€‚ä¸Šé¢ä»£ç ä¸­```ConnectFunction```æ˜¯æ ¸å¿ƒå‡½æ•°ï¼Œè™½ç„¶ä¸­é—´éƒ¨åˆ†ä»£ç çœç•¥ï¼Œä¸è¿‡ç•™ä¸‹çš„éƒ½æ˜¯ç²¾åã€‚

åœ¨```ConnectFunction```å‡½æ•°ä¸­ï¼Œé€šè¿‡```hooks useContext```è·å–Providerç»„ä»¶çš„```contextValue```å¯¹è±¡ï¼›```renderedWrappedComponent```å°†[actualChildProps](https://github.com/reduxjs/react-redux/blob/master/src/components/connectAdvanced.js#L260)ä½œä¸ºpropsä¼ å…¥ï¼ŒactualChildPropsæ˜¯å·²ç»å¤„ç†è¿‡çš„propså±æ€§ï¼Œä¸Šé¢å·²ç»æŒ‚è½½äº†```dispatch```å‡½æ•°å’Œ```state```çŠ¶æ€ç­‰å±æ€§ï¼›è€Œ```renderedChild```ç»„ä»¶ï¼Œå…¶å®connectå‡½æ•°æœ€åè¿”å›çš„å®é™…å†…å®¹ã€‚(ä¸­é—´éƒ¨åˆ†ä»£ç çœç•¥äº†[æºç é“¾æ¥è·³è½¬](https://github.com/reduxjs/react-redux/blob/master/src/components/connectAdvanced.js#L149))

ä»¥ä¸Šå°±æ˜¯Proviceç»„ä»¶å’Œconnectç»„ä»¶åˆæ¬¡è°ƒç”¨æ—¶ï¼Œæ‰€ç»è¿‡çš„å®é™…ä»£ç ï¼Œå½“ç„¶åœ¨å…¶ä¸­æœ‰ä¸€äº›åˆ å‡ï¼Œä¸è¿‡åŸºæœ¬éƒ½æœ‰è¯´åˆ°ã€‚

å½“dispatchè¢«è°ƒç”¨æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¸Šé¢éƒ¨åˆ†å®Œå…¨æ²¡æœ‰è¯´åˆ°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å½“```dispatch(action)```è°ƒç”¨åï¼Œreact-reduxå†…éƒ¨ï¼Œæ˜¯å¦‚ä½•æ›´æ–°connectç»„ä»¶ã€‚

## connectå¦‚ä½•æ›´æ–°ï¼Ÿ

å½“åœ¨Reactåº”ç”¨ä¸­è°ƒç”¨dispatchå‡½æ•°æ—¶ï¼Œreduxä¸­å®é™…è°ƒç”¨çš„å°±æ˜¯reducerå‡½æ•°ï¼ŒåŒæ—¶è¿”å›æ–°çš„stateã€‚é‚£ä¹ˆredux-reactä¸­çš„connectç»„ä»¶å¦‚ä½•æ›´æ–°å‘¢ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹æ›´æ–°çš„æµç¨‹ï¼š
```javascript
dispatch(action)
```
**ä¸‹é¢å†…å®¹ä¸æ˜¯ç²¾è¯»ä»£ç ï¼Œåªæ˜¯èŠä¸€ä¸‹åŸºæœ¬çš„æµç¨‹**ã€‚

### åˆå§‹åŒ–
å½“```Provider```ç»„ä»¶è¢«è°ƒç”¨æ³¨å†Œæ—¶ï¼Œè®¢é˜…æ›´æ–°**Subscription**å‡½æ•°è¢«æ³¨å†Œï¼š
```javascript
const subscription = new Subscription(store)
```
åœ¨redux-reactä¸­ï¼Œ**è®¢é˜…å‘å¸ƒå‡½æ•°[Subscription](https://github.com/reduxjs/react-redux/blob/master/src/utils/Subscription.js#L52)æ˜¯å…¶ä¸­çš„æ ¸å¿ƒå‡½æ•°(**è®¢é˜…å‘å¸ƒæ¨¡å¼æ˜¯å…¶æ ¸å¿ƒ**)ï¼Œå®ƒæœ‰æ•ˆçš„ä¿è¯connectç»„ä»¶çš„æ›´æ–°æ¸²æŸ“ã€‚```store```ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°Subscriptionæ„é€ å‡½æ•°å†…éƒ¨ï¼Œä½œç”¨å°±æ˜¯Subscriptionå†…éƒ¨ä½¿ç”¨**ã€‚

### è®¢é˜…
```javascript
return connect(mapStateToProps, mapDispatchToProps)(Component)
```
```javascript
// react-reduxä¸­ï¼ŒcheckForUpdateså‡½æ•°ï¼Œè´Ÿè´£æ›´æ–°connectç»„ä»¶
subscription.onStateChange = checkForUpdates

// reduxä¿å­˜è§¦å‘ é€šçŸ¥å‡½æ•°
store.subscribe(subscription.notifyNestedSubs);

// react-reduxä¿å­˜ æ›´æ–°å‡½æ•°
subscription.listeners.subscribe(subscription.onStateChange)
```
åœ¨connectç»„ä»¶è¢«ä½¿ç”¨æ—¶ï¼Œreact-reduxä¸­çš„subscriptionå¯¹è±¡ï¼Œä¼šå°†connectç»„ä»¶çš„```checkForUpdates```æ›´æ–°å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥ä¿å­˜åœ¨subscriptionçš„è®¢é˜…æ•°ç»„nextä¸­ï¼›åŒæ—¶ï¼Œreduxä¹Ÿä¼šå‘ç”Ÿç›¸åŒçš„æ“ä½œã€åœ¨react-reduxä¸­ä¹Ÿæœ‰ä½¿ç”¨åˆ°reduxä¸­æ–¹æ³•ã€‘ã€‚(ä»£ç ä¸ºç®€åŒ–ç‰ˆ)
```javascript
// reduxä¸­ subscribeå‡½æ•°
let nextListeners = []
subscribe(listener) {
   // ... 
   nextListeners.push(listener)
}
// react-reduxä¸­ subscribeå‡½æ•°
let next = []
subscribe(listener) {
   // ... 
   next.push(listener)
}

```
[```checkForUpdates```](https://github.com/reduxjs/react-redux/blob/master/src/components/connectAdvanced.js#L307)å‡½æ•°è´Ÿè´£connectç»„ä»¶çš„å†…éƒ¨çš„çŠ¶æ€æ›´æ–°ã€‚

```notifyNestedSubs```å‡½æ•°æ˜¯ä½œç”¨æ˜¯è§¦å‘react-reduxä¸­çš„subscriptionå¯¹è±¡çš„æ›´æ–°å‡½æ•°ï¼Œè€Œå®ƒè¢«ä¿å­˜åœ¨nextListenersæ•°ç»„ä¸­ï¼Œæ˜¯ä¸ºäº†å½“reduxçš„dispatchå‡½æ•°è¢«è§¦å‘æ—¶ï¼Œè°ƒç”¨notifyNestedSubsé€šçŸ¥å‡½æ•°ï¼Œè¿›è€Œè§¦å‘react-reduxçš„connectç»„ä»¶çš„checkForUpdatesæ›´æ–°å‡½æ•°ã€‚

[react-reduxï¼šcheckForUpdates å‡½æ•°æºç ](https://github.com/reduxjs/react-redux/blob/master/src/components/connectAdvanced.js#L307)

[react-reduxï¼šSubscription å‡½æ•°æºç ](https://github.com/reduxjs/react-redux/blob/master/src/utils/Subscription.js#L52)

### å‘å¸ƒ(æ›´æ–°)

```dispatch(action)```å‘èµ·è§¦å‘æ“ä½œåï¼Œå½“ç„¶æ˜¯è§¦å‘storeä¸­dispatchå‡½æ•°äº†ï¼Œä¿®æ”¹storeä¸­stateçš„å€¼ï¼Œæ›´æ–°éå†reduxçš„nextListenersè®¢é˜…æ•°ç»„ï¼Œè§¦å‘é€šçŸ¥å‡½æ•°```notifyNestedSubs```è°ƒç”¨ï¼›åŒæ—¶ï¼Œè¿™ä¼šå¯¼è‡´react-reduxä¸­çš„nextæ•°ç»„ï¼Œè¢«è§¦å‘éå†è°ƒç”¨ã€‚ä¸¤ä¸ªåº“åŸºæœ¬éƒ½æ˜¯ä¸‹é¢çš„ä»£ç 
```javascript
let next = listeners;â€‹
for (let i = 0; i < listeners.length; i++) {
  listeners[i]()
}
```

ä»¥ä¸Šç»†èŠ‚å¯èƒ½æœ‰æ‰€çœç•¥ï¼Œä½†åŸºæœ¬å°±æ˜¯å…ˆè®¢é˜…ï¼Œå°†æ›´æ–°å‡½æ•°ä¿å­˜è¿›å…¥è®¢é˜…æ•°ç»„ï¼Œç„¶åå½“dispatchå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œéå†è°ƒç”¨è®¢é˜…æ•°ç»„ï¼Œå®Œæˆconnectç»„ä»¶çš„æ›´æ–°ã€‚

åœ¨æœ€æ–°çš„react-redxuåº“ä¸­ ï¼Œæœ‰å¤§é‡çš„React Hookså‡ºç°ï¼Œä¸­é—´æˆ‘æœ¨æœ‰è¿‡å¤šçš„è¯´æ˜ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚(é«˜é˜¶ç»„ä»¶ã€React Hooksã€è®¢é˜…å‘å¸ƒæ¨¡å¼)

ps: å¾®ä¿¡å…¬ä¼—å·ï¼šYopaiï¼Œæœ‰å…´è¶£çš„å¯ä»¥å…³æ³¨ï¼Œæ¯å‘¨ä¸å®šæœŸæ›´æ–°ã€‚ä¸æ–­åˆ†äº«ï¼Œä¸æ–­è¿›æ­¥

![](/webChat1.png)
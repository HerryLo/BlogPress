---
title: '🔥react-redux原理解析'
description: HerryLo, 微信公众号： Yopai
data: 2019-12-20 11:40
tags: react-redux，原理解析
---

# react-redux原理解析

在之前的一篇文章中已讲过[redux 原理解析](https://didiheng.com/front/2019-10-26.html)，我将```redux```返回的store对象挂载在window中，不是太懂的同学可以看看之前的[redux 原理解析](https://didiheng.com/front/2019-10-26.html)。

```javascript
const reducer = combineReducers({
    home: homeNumber,
    number: addNumber
})
const store = createStore(reducer)
window.$reduxStore = store

// 使用
window.$reduxStore.dispatch(action);
let { state } = window.$reduxStore.getState()
```
但在平时的开发中，一般却是将```redux+c```配合使用，下面就一起来解析```react-redux```常使用的方法。<span style="color: red;font-weight: 900;">【下面是以最新版本react-redux@7.1.3库解析】</span>

## Provider函数

```react-redux```提供了```<Provider />```用来挂载redux返回的store对象，只需要注入一次。

```javascript
ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  rootElement
)
```
下面看看```<Provider />```做了什么：

```javascript
function Provider({ store, context, children }) {
  // 依赖项store变化触发，返回store和subscription
  const contextValue = useMemo(() => {
    // 确保在后代之前重新渲染祖先组件
    const subscription = new Subscription(store)
    subscription.onStateChange = subscription.notifyNestedSubs
    return {
      store,
      subscription
    }
  }, [store])
  // 依赖项store变化触发
  const previousState = useMemo(() => store.getState(), [store])

  // 依赖项contextValue, previousState变化触发
  useEffect(() => {
    const { subscription } = contextValue
    subscription.trySubscribe()

    if (previousState !== store.getState()) {
      subscription.notifyNestedSubs()
    }
    return () => {
      // 组件销毁清除监听
      subscription.tryUnsubscribe()
      subscription.onStateChange = null
    }
  }, [contextValue, previousState])
  // ReactReduxContext = React.createContext(null)
  const Context = context || ReactReduxContext

  return <Context.Provider value={contextValue}>{children}</Context.Provider>
}
```
在原应用组件上包裹一层，使原来整个应用成为Provider的子组件，[Context.Provider API](https://zh-hans.reactjs.org/docs/context.html#contextprovider)：当 Provider 的 value 值发生变化时，它内部的所有消费组件都会重新渲染。


## connect函数

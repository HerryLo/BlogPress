---
title: '🔥react-redux原理解析'
description: HerryLo, 微信公众号： Yopai
data: 2019-12-20 11:40
tags: react-redux，原理解析
---

# react-redux原理解析

在之前的一篇文章中已讲过[redux 原理解析](https://didiheng.com/front/2019-10-26.html)，我将```redux```返回的store对象挂载在window中，不是太懂的同学可以看看之前的[redux 原理解析](https://didiheng.com/front/2019-10-26.html)。

```javascript
const reducer = combineReducers({
    home: homeNumber,
    number: addNumber
})
const store = createStore(reducer)
window.$reduxStore = store

// 使用
window.$reduxStore.dispatch(action);
let { state } = window.$reduxStore.getState()
```
但在平时的开发中，一般却是将```redux+c```配合使用，下面就一起来解析```react-redux```常使用的方法。<span style="color: red;font-weight: 900;">【下面是以最新版本react-redux@7.1.3库解析】</span>，【下面的源码尽量简略】

## Provider函数

```react-redux```提供了```<Provider />```用来挂载redux返回的store对象，只需要注入一次。

```javascript
ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  rootElement
)
```
下面看看```<Provider store={store} />```做了什么：

```javascript
function Provider({ store, context, children }) {
  // 依赖项store变化触发，返回store和subscription
  const contextValue = useMemo(() => {
    //...
    return {
      store,
      subscription
    }
  }, [store])
  //...
  
  // ReactReduxContext = React.createContext(null)
  const Context = context || ReactReduxContext

  return <Context.Provider value={contextValue}>{children}</Context.Provider>
}
// 源码地址：https://github.com/reduxjs/react-redux/blob/master/src/components/Provider.js#L6
```
Provider接收三个参数，store参数接收store对象，context参数接收上下文对象，children参数接收ReactElement元素；
在原应用组件上包裹一层，使原来整个应用成为Provider的子组件，[Context.Provider API](https://zh-hans.reactjs.org/docs/context.html#contextprovider)：只有当 Provider 的 value 值发生变化时，它内部的所有消费组件都会重新渲染。

```contextValue```上挂载了store和订阅更新subscription对象，store在这里不做解释，就是redux返回的store。在下面将会继续说到subscription订阅函数。

## connect函数

```connect```的常见使用示例如下：

```javascript
return connect(mapStateToProps, mapDispatchToProps)(Component)
```

```connect```函数就是一个高阶函数，主要就是将```state```和```dispatch```等属性挂载Component的props上。

```javascript
import hoistStatics from 'hoist-non-react-statics'
import { ReactReduxContext } from './Context';

// 核心函数 return组件
function ConnectFunction (props) {
  // 判断props 是否存在store & getState & dispatch
  var didStoreComeFromProps = Boolean(props.store) && Boolean(props.store.getState) && Boolean(props.store.dispatch);
  // 获取到Provider组件挂载的contextValue
  var ContextToUse = useMemo(function () {
    return props.context || ReactReduxContext
  })
  var contextValue = useContext(ContextToUse)
  //  ...
  // store对象
  var store = didStoreComeFromProps ? props.store : contextValue.store;

  // 依赖返回 contextValue
  var overriddenContextValue = useMemo(function () {
    if (didStoreComeFromProps) {
      return contextValue;
    }
    // copy一个新的contextValue
    return _extends({}, contextValue, {
      subscription: subscription
    });
  }, [didStoreComeFromProps, contextValue, subscription]);

  //  ...
  // 返回渲染ReactElement
  var renderedChild = useMemo(function () {
    // 是否存在mapStateToProps函数
    if (shouldHandleStateChanges) {
      return React.createElement(ContextToUse.Provider, {
        value: overriddenContextValue
      }, renderedWrappedComponent);
    }
    // renderedWrappedComponent 渲染容器组件
    return renderedWrappedComponent;
  }, [ContextToUse, renderedWrappedComponent, overriddenContextValue]);
  return renderedChild;
}
//  ...
// 与Object.assign类似操作
return hoistStatics(ConnectFunction, Component)
```

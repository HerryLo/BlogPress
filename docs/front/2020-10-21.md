---
title: Axios部分源码解析--拦截器
description: HerryLo, 微信公众号： Yopai
date: 2020-10-21 11:55
tags: Axios
---

在Axios中拦截器是如何注册和调用的呢？下面我们依赖来看看

浏览器端Axios调用流程如下：

```
初始化Axios——> 注册拦截器 ——> 请求拦截——> ajax请求 ——> 响应拦截 ——> 请求响应回调
```

## Axios初始化

第一步：当然调用Axios请求时初始化了

```javascript
// 初始化Axios
function Axios(instanceConfig) {
  this.defaults = instanceConfig;
  this.interceptors = {
    request: new InterceptorManager(),
    response: new InterceptorManager()
  };
}

module.exports = Axios;
```
InterceptorManager和InterceptorManager函数分别是是request拦截器和response拦截器，注册拦截器回调函数，**这里只会讲/*请求拦截器*/，因为响应拦截器基本也是这个流程**；这样我们将`this.interceptors.request.use`来添加拦截器函数了，那么这里`InterceptorManager`函数做了什么呢？

## InterceptorManager注册拦截函数

```javascript
function InterceptorManager() {
  this.handlers = [];
}

//负责将拦截回调函数保存在handlers中
InterceptorManager.prototype.use = function use(fulfilled, rejected) {
  this.handlers.push({
    fulfilled: fulfilled,
    rejected: rejected
  });
  return this.handlers.length - 1;
};
```
不论请求还是回调拦截器，都是通过`InterceptorManager`函数来完成的。

## ## 调用拦截器函数和请求函数

```javascript
utils.forEach(['delete', 'get', 'head', 'options'], function forEachMethodNoData(method) {
  /*eslint func-names:0*/
  Axios.prototype[method] = function(url, config) {
    return this.request(mergeConfig(config || {}, {
      method: method,
      url: url,
      data: (config || {}).data
    }));
  };
});
```
`this.request`负责触发拦截器函数和ajax请求函数，继续向下看

```javascript
Axios.prototype.request = function request(config) {
  // dispatchRequest函数即ajax请求函数
  var chain = [dispatchRequest, undefined];
  var promise = Promise.resolve(config);

  this.interceptors.request.forEach(function unshiftRequestInterceptors(interceptor) {
      chain.unshift(interceptor.fulfilled, interceptor.rejected);
  });

  this.interceptors.response.forEach(function pushResponseInterceptors(interceptor) {
      chain.push(interceptor.fulfilled, interceptor.rejected);
  });

  // 组装 Promise 调用链,完成链式调用
  while (chain.length) {
      promise = promise.then(chain.shift(), chain.shift());
  }

  return promise;
};
```

看下面的就理解了👇
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12cbfa5ce9aa4983b80a039eb5e5d83b~tplv-k3u1fbpfcp-zoom-1.image)
<center>（图来源自转载）</center>

参考：

[77.9K Star 的 Axios 项目有哪些值得借鉴的地方](https://juejin.im/post/6885471967714115597#heading-3)

[Axios拦截器核心源码](https://github.com/axios/axios/blob/master/lib/core/Axios.js#L27)

